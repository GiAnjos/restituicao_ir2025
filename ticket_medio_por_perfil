WITH

cte1 AS
(
SELECT 
LPAD(num_documento_identificacao,11,'0') num_documento_identificacao
,CASE WHEN SUM(CAST(val_estoque_titulo_publico_tesouro_direto AS DECIMAL)) > 250000 THEN 'Sofisticado'
ELSE 'Digital' END AS perfil
FROM estoque_com_cpf_20250604 
GROUP BY LPAD(num_documento_identificacao,11,'0')
)
,

imp AS (
SELECT c.*,
CASE 
    WHEN clust.classificacao IN ('Digital','Sofisticado') THEN clust.classificacao
    WHEN cte1.perfil IN ('Digital','Sofisticado') THEN cte1.perfil
    ELSE 'NÃ£o mapeado' END AS perfil 
FROM restituicao_ir2025_completa c 
LEFT JOIN restituicao_ir2025_grupo_controle_lotes_1_e2 gc ON c.cpf = REPLACE(gc.cpf,'"','') 
LEFT JOIN clusterizacao_2024_tratado clust ON c.cpf = LPAD(clust.CPF,11,'0')
LEFT JOIN cte1 ON LPAD(c.cpf,11,'0') = LPAD(num_documento_identificacao,11,'0')

WHERE REPLACE(gc.cpf,'"','') IS NULL AND c.lote IN ('001','002')
),

gc AS (
SELECT
REPLACE(gc.cpf,'"','') cpf,
REPLACE(gc.lote,'"','') lote,
REPLACE(gc.flagagencia,'"','') flagagencia
FROM restituicao_ir2025_grupo_controle_lotes_1_e2 gc 
WHERE REPLACE(gc.lote,'"','') IN ('001','002')
),

conv_gc AS (
SELECT
LPAD(m.num_documento_identificacao,11, '0') cpf,
gc.flagagencia,
gc.lote,
m.val_total_negociado
FROM movimentacao_recente_dremio m
INNER JOIN gc ON gc.cpf = LPAD(m.num_documento_identificacao,11, '0')
WHERE m.data_operacao_titulo_publico >= DATE '2025-07-02' 
),

conv AS (
SELECT
LPAD(m.num_documento_identificacao,11, '0') cpf,
imp.flagagencia,
imp.lote,
imp.perfil,
m.val_total_negociado
FROM movimentacao_recente_dremio m
INNER JOIN imp ON imp.cpf = LPAD(m.num_documento_identificacao,11, '0')
WHERE m.data_operacao_titulo_publico >= DATE '2025-07-02' 
)

SELECT
SUM (val_total_negociado)/ COUNT (DISTINCT cpf) total_cpfs,
perfil
FROM conv
GROUP BY 2

-- ticket medio total
-- SELECT
-- SUM (val_total_negociado)/ COUNT (DISTINCT cpf) 
-- FROM conv
 
--Mediana do valor investido por perfil 
--SELECT
--APPROX_PERCENTILE (val_total_negociado,0.5) mediana,
--perfil
--FROM conv
--GROUP BY 2

--novos investidores por perfil
--SELECT
--COUNT (DISTINCT cpf) total_cpf,
--conv.perfil
--FROM conv 
--LEFT JOIN cte1 ON conv.cpf = num_documento_identificacao
--WHERE num_documento_identificacao IS NULL
--GROUP BY 2

-- SELECT
-- COUNT (DISTINCT cpf) total_cpf,
-- conv.perfil
-- FROM conv 
-- INNER JOIN  cte1 ON conv.cpf = num_documento_identificacao
-- GROUP BY 2
 
